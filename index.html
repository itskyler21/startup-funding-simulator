<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å­¦ç”Ÿåˆ›ä¸šè´¢æ”¿æ”¯æŒæ¨¡æ‹Ÿå¹³å° (ä¸“ä¸šç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js for dynamic charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- xlsx.js (SheetJS) for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .prose h3 { font-size: 1.2rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose strong { color: #1e40af; }
    </style>
</head>
<body class="gradient-bg text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">å¤§å­¦ç”Ÿåˆ›ä¸šè´¢æ”¿æ”¯æŒæ¨¡æ‹Ÿå¹³å°</h1>
            <p class="text-lg text-gray-600 mt-2">ä¸€ä¸ªä¸ºæ¢¦æƒ³åŠ é€Ÿçš„AIæ”¿ç­–æ¨¡æ‹Ÿæ²™ç›˜ (DeepSeek AI ä¸“ä¸šç‰ˆ)</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Input Section -->
            <section class="lg:col-span-2 bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">1. è¾“å…¥é¡¹ç›®ä¿¡æ¯</h2>
                <div class="space-y-4">
                     <div>
                        <label for="capital" class="block text-sm font-medium text-gray-700 mb-1">å¯åŠ¨èµ„é‡‘ (å…ƒ)</label>
                        <input type="number" id="capital" value="100000" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                     <div>
                        <label for="monthly_income" class="block text-sm font-medium text-gray-700 mb-1">é¢„ä¼°æœˆæ”¶å…¥ (å…ƒ)</label>
                        <input type="number" id="monthly_income" value="20000" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    <div>
                        <label for="monthly_cost" class="block text-sm font-medium text-gray-700 mb-1">é¢„ä¼°æœˆæˆæœ¬ (å…ƒ)</label>
                        <input type="number" id="monthly_cost" value="15000" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    <div>
                        <label for="industry" class="block text-sm font-medium text-gray-700 mb-1">æ‰€å±è¡Œä¸š</label>
                        <input type="text" id="industry" value="æ–‡åŒ–åˆ›æ„" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    <div>
                        <label for="region" class="block text-sm font-medium text-gray-700 mb-1">æ‰€åœ¨åœ°åŒº</label>
                        <input type="text" id="region" value="ä¸Šæµ·" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                     <div>
                        <label for="subsidy_amount" class="block text-sm font-medium text-gray-700 mb-1">æ¨¡æ‹Ÿè¡¥è´´é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="subsidy_amount" value="10000" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                    </div>
                    <div>
                        <label for="project_description" class="block text-sm font-medium text-gray-700 mb-1">è¯·ç®€å•æè¿°é¡¹ç›®éœ€æ±‚</label>
                        <textarea id="project_description" rows="4" class="w-full bg-white border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»¬éœ€è¦é‡‡è´­ä¸€æ‰¹è®¾å¤‡ï¼Œå¹¶ä¸”éœ€è¦ä¸€ä¸ªä¾¿å®œçš„åŠå…¬åœºåœ°..."></textarea>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="simulateBtn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center mx-auto w-full">
                        <span id="simulateBtnText">âœ¨ å¼€å§‹æ™ºèƒ½æ¨¡æ‹Ÿ</span>
                        <div id="simulateSpinner" class="spinner hidden"></div>
                    </button>
                </div>
            </section>

            <!-- Output Section -->
            <section class="lg:col-span-3">
                <div id="initial-message" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg h-full flex items-center justify-center">
                    <p class="text-gray-500 text-center">è¯·åœ¨å·¦ä¾§è¾“å…¥ä¿¡æ¯åç‚¹å‡»æ¨¡æ‹Ÿï¼Œ<br>æ­¤å¤„å°†å±•ç¤ºAIæ”¿ç­–åˆ†æã€è´¢åŠ¡å›¾è¡¨åŠå¯¼å‡ºæŠ¥å‘ŠåŠŸèƒ½ã€‚</p>
                </div>
                
                <div id="results-area" class="hidden space-y-8">
                    <!-- Report Content Area for PDF Export -->
                    <div id="report-content" class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">2. AI æ”¿ç­–åŒ¹é…åˆ†æ</h2>
                        <div id="ai-answer-container" class="prose max-w-none">
                           <!-- AI Answer will be rendered here -->
                        </div>
                        
                        <hr class="my-6">

                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">3. è´¢åŠ¡é¢„æµ‹è¾“å‡º</h2>
                        <div id="financial-summary" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                            <!-- Summary cards will be injected here by JS -->
                        </div>

                        <hr class="my-6">

                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">4. å¯è§†åŒ–å›¾è¡¨</h2>
                         <div class="w-full h-80">
                           <canvas id="financial-chart"></canvas>
                        </div>
                    </div>

                    <!-- Export Section -->
                    <div class="bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">5. å¯¼å‡ºåˆ†ææŠ¥å‘Š</h2>
                        <p class="text-gray-600 mb-4">å°†ä»¥ä¸Šåˆ†æç»“æœä¿å­˜ä¸ºPDFæ–‡ä»¶æˆ–å°†è¯¦ç»†è´¢åŠ¡æ•°æ®å¯¼å‡ºä¸ºExcelè¡¨æ ¼ã€‚</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="exportPdfBtn" class="flex-1 bg-red-600 text-white font-bold py-3 px-6 rounded-full hover:bg-red-700 transition duration-300 shadow-md flex items-center justify-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm6 10a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM2 10a8 8 0 1116 0 8 8 0 01-16 0z" /></svg>
                                <span>å¯¼å‡ºä¸º PDF</span>
                            </button>
                            <button id="exportExcelBtn" class="flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-full hover:bg-green-700 transition duration-300 shadow-md flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M2 5a2 2 0 012-2h12a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm14 0H4v10h12V5zM6 7h8v2H6V7zm0 4h8v2H6v-2z" /></svg>
                                <span>å¯¼å‡ºä¸º Excel</span>
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

<script type="module">
    // --- DOM Elements ---
    const simulateBtn = document.getElementById('simulateBtn');
    const simulateBtnText = document.getElementById('simulateBtnText');
    const simulateSpinner = document.getElementById('simulateSpinner');
    
    const initialMessage = document.getElementById('initial-message');
    const resultsArea = document.getElementById('results-area');
    const aiAnswerContainer = document.getElementById('ai-answer-container');
    const financialSummaryContainer = document.getElementById('financial-summary');
    const financialChartCanvas = document.getElementById('financial-chart');
    
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const exportExcelBtn = document.getElementById('exportExcelBtn');
    
    let financialChart = null;
    let financialDataForExport = null;

    // --- DeepSeek AI Configuration ---
    const DEEPSEEK_API_KEY = "sk-8dc826f0818b46088450e6dabfe5a785"; // ğŸ‘‰ åœ¨æ­¤å¤„å¡«å†™ä½ çš„DeepSeek APIå¯†é’¥ï¼ˆè·å–åœ°å€ï¼šhttps://www.deepseek.com/console/api-keysï¼‰
    const DEEPSEEK_API_URL = "https://api.deepseek.com/v1/chat/completions";
    
    const POLICY_DATABASE = `
    - **æ”¿ç­–åç§°:** é¦–æ¬¡åˆ›ä¸šä¸€æ¬¡æ€§è¡¥è´´ | **é€‚ç”¨åŒºåŸŸ:** å…¨å›½å¤šåœ°ï¼ˆå¦‚ä¸Šæµ·ã€æ·±åœ³ï¼‰ | **æ ¸å¿ƒæ¡ä»¶:** æ¯•ä¸š5å¹´å†…é«˜æ ¡æ¯•ä¸šç”Ÿ, é¦–æ¬¡åœ¨å½“åœ°åˆ›åŠå°å¾®ä¼ä¸š, æ­£å¸¸ç»è¥6ä¸ªæœˆä»¥ä¸Š | **è¡¥è´´è¯¦æƒ…:** è¡¥è´´ 8,000 - 15,000 å…ƒä¸ç­‰ï¼Œä¸€æ¬¡æ€§å‘æ”¾ã€‚
    - **æ”¿ç­–åç§°:** å°å¾®ä¼ä¸šæ™®æƒ æ€§ç¨æ”¶å‡å… | **é€‚ç”¨åŒºåŸŸ:** å…¨å›½ | **æ ¸å¿ƒæ¡ä»¶:** å¹´åº”çº³ç¨æ‰€å¾—é¢ä¸è¶…è¿‡100ä¸‡å…ƒ | **è¡¥è´´è¯¦æƒ…:** å¹´åº”çº³ç¨æ‰€å¾—é¢ä¸è¶…è¿‡100ä¸‡å…ƒçš„éƒ¨åˆ†ï¼Œå®é™…ä¼ä¸šæ‰€å¾—ç¨ç¨è´Ÿä¸º5%ã€‚
    - **æ”¿ç­–åç§°:** åˆ›ä¸šæ‹…ä¿è´·æ¬¾åŠè´´æ¯ | **é€‚ç”¨åŒºåŸŸ:** å…¨å›½ | **æ ¸å¿ƒæ¡ä»¶:** ç¬¦åˆæ¡ä»¶çš„é«˜æ ¡æ¯•ä¸šç”Ÿç­‰ | **è¡¥è´´è¯¦æƒ…:** æ”¿åºœå¯¹è´·æ¬¾åˆ©æ¯è¿›è¡Œè¡¥è´´ï¼Œåˆ›ä¸šè€…å®é™…æ‰¿æ‹…çš„åˆ©æ¯æä½ã€‚
    - **æ”¿ç­–åç§°:** åˆ›ä¸šå¸¦åŠ¨å°±ä¸šè¡¥è´´ | **é€‚ç”¨åŒºåŸŸ:** å…¨å›½å¤šåœ° | **æ ¸å¿ƒæ¡ä»¶:** åˆåˆ›ä¼ä¸šæ‹›ç”¨æ¯•ä¸š2å¹´å†…é«˜æ ¡æ¯•ä¸šç”Ÿ | **è¡¥è´´è¯¦æƒ…:** æ¯æ‹›ç”¨ä¸€äººï¼Œç»™äºˆä¼ä¸š 2,000 - 5,000 å…ƒçš„ä¸€æ¬¡æ€§è¡¥è´´ã€‚
    `;

    // --- Helper Functions ---
    function setButtonLoading(btnTextEl, spinnerEl, btnEl, isLoading) {
        btnEl.disabled = isLoading;
        if (isLoading) {
            btnTextEl.classList.add('hidden');
            spinnerEl.classList.remove('hidden');
        } else {
            btnTextEl.classList.remove('hidden');
            spinnerEl.classList.add('hidden');
        }
    }
    
    // è°ƒç”¨DeepSeek AIçš„æ ¸å¿ƒå‡½æ•°
    async function callDeepSeekAI(prompt) {
        try {
            // æ„å»ºç¬¦åˆDeepSeekè¦æ±‚çš„è¯·æ±‚ä½“
            const payload = {
                model: "deepseek-chat", // DeepSeekå¯¹è¯æ¨¡å‹ï¼ˆå›ºå®šå€¼ï¼‰
                messages: [{ role: "user", content: prompt }], // ç”¨æˆ·æé—®
                temperature: 0.7, // å›ç­”çµæ´»åº¦
                max_tokens: 1000 // æœ€å¤§å›ç­”é•¿åº¦
            };
            
            // å‘é€è¯·æ±‚åˆ°DeepSeek API
            const response = await fetch(DEEPSEEK_API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${DEEPSEEK_API_KEY}` // å¯†é’¥è®¤è¯
                },
                body: JSON.stringify(payload)
            });
            
            // å¤„ç†è¯·æ±‚å¤±è´¥
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorData.error?.message || "æœªçŸ¥é”™è¯¯"}`);
            }
            
            // è§£æè¿”å›ç»“æœ
            const result = await response.json();
            const aiAnswer = result.choices?.[0]?.message?.content;
            return aiAnswer || "æŠ±æ­‰ï¼ŒAIæœªèƒ½ç”Ÿæˆæœ‰æ•ˆå›å¤ã€‚";
        } catch (error) {
            console.error("DeepSeek APIè°ƒç”¨é”™è¯¯:", error);
            return `ç½‘ç»œæˆ–APIè¯·æ±‚å‡ºé”™: ${error.message}ã€‚`;
        }
    }

    // --- è´¢åŠ¡æ•°æ®ç”Ÿæˆä¸æ¸²æŸ“ ---
    function generateFinancialData(inputs) {
        const data = {
            months: [],
            noSubsidy: [],
            withSubsidy: []
        };

        let cashNoSubsidy = Number(inputs.capital);
        let cashWithSubsidy = Number(inputs.capital) + Number(inputs.subsidy_amount);
        const netFlow = Number(inputs.monthly_income) - Number(inputs.monthly_cost);

        for (let i = 1; i <= 12; i++) {
             // ç¬¬1ä¸ªæœˆï¼šå¯åŠ¨èµ„é‡‘ + é¦–æœˆå‡€ç°é‡‘æµï¼ˆè¡¥è´´å·²é¢„å…ˆåŠ å…¥withSubsidyï¼‰
            if (i === 1) {
                cashNoSubsidy += netFlow;
                cashWithSubsidy += netFlow;
            } else { 
               cashNoSubsidy += netFlow;
               cashWithSubsidy += netFlow;
            }
            data.months.push(`ç¬¬${i}æœˆ`);
            data.noSubsidy.push(cashNoSubsidy);
            data.withSubsidy.push(cashWithSubsidy);
        }
        return data;
    }

    function renderFinancialSummary(data, subsidyAmount) {
        const endCashNoSubsidy = data.noSubsidy[data.noSubsidy.length - 1];
        const endCashWithSubsidy = data.withSubsidy[data.withSubsidy.length - 1];
        const netGain = subsidyAmount; 

        const formatCurrency = (value) => new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(value);

        financialSummaryContainer.innerHTML = `
            <div class="bg-blue-100 p-4 rounded-lg text-center shadow">
                <p class="text-sm font-medium text-blue-700">å¹´æœ«ç°é‡‘ (æœ‰è¡¥è´´)</p>
                <p class="text-2xl font-bold text-blue-900">${formatCurrency(endCashWithSubsidy)}</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg text-center shadow">
                <p class="text-sm font-medium text-red-700">å¹´æœ«ç°é‡‘ (æ— è¡¥è´´)</p>
                <p class="text-2xl font-bold text-red-900">${formatCurrency(endCashNoSubsidy)}</p>
            </div>
            <div class="bg-green-100 p-4 rounded-lg text-center shadow">
                <p class="text-sm font-medium text-green-700">è¡¥è´´å¸¦æ¥å‡€å¢ç›Š</p>
                <p class="text-2xl font-bold text-green-900">${formatCurrency(netGain)}</p>
            </div>
        `;
    }

    function renderChart(data) {
        if (financialChart) {
            financialChart.destroy();
        }
        const ctx = financialChartCanvas.getContext('2d');
        financialChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.months,
                datasets: [{
                    label: 'æ— è¡¥è´´æœŸæœ«ç°é‡‘',
                    data: data.noSubsidy,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    fill: true,
                    tension: 0.3
                }, {
                    label: 'æœ‰è¡¥è´´æœŸæœ«ç°é‡‘',
                    data: data.withSubsidy,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: false, ticks: { callback: (value) => `Â¥${value / 1000}k` } } },
                plugins: {
                    title: { display: true, text: '12ä¸ªæœˆç°é‡‘æµæ¨¡æ‹Ÿå¯¹æ¯”', font: { size: 16 } },
                    tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('zh-CN', { style: 'currency', currency: 'CNY' }).format(c.raw)}` } }
                }
            }
        });
    }

    // --- æŒ‰é’®ç‚¹å‡»äº‹ä»¶ ---
    simulateBtn.addEventListener('click', async () => {
        setButtonLoading(simulateBtnText, simulateSpinner, simulateBtn, true);
        initialMessage.classList.add('hidden');
        resultsArea.classList.remove('hidden');
        aiAnswerContainer.innerHTML = '<div class="spinner mx-auto"></div>';
        financialSummaryContainer.innerHTML = '';


        const inputs = {
            capital: document.getElementById('capital').value,
            industry: document.getElementById('industry').value,
            region: document.getElementById('region').value,
            monthly_income: document.getElementById('monthly_income').value,
            monthly_cost: document.getElementById('monthly_cost').value,
            subsidy_amount: document.getElementById('subsidy_amount').value,
            project_description: document.getElementById('project_description').value
        };

        // --- 1. AIæ”¿ç­–åˆ†æï¼ˆè°ƒç”¨DeepSeekï¼‰---
        const userSituation = `æˆ‘æ˜¯ä¸€åå‡†å¤‡åˆ›ä¸šçš„å¤§å­¦ç”Ÿï¼Œé¡¹ç›®åŸºæœ¬æƒ…å†µå¦‚ä¸‹ï¼šå¯åŠ¨èµ„é‡‘${inputs.capital}å…ƒï¼Œé¢„ä¼°æœˆæ”¶å…¥${inputs.monthly_income}å…ƒï¼Œé¢„ä¼°æœˆæˆæœ¬${inputs.monthly_cost}å…ƒï¼Œæ‰€å±è¡Œä¸šæ˜¯â€œ${inputs.industry}â€ï¼Œè®¡åˆ’åœ¨â€œ${inputs.region}â€å‘å±•ã€‚æˆ‘çš„å…·ä½“éœ€æ±‚æ˜¯ï¼šâ€œ${inputs.project_description}â€ã€‚`;
        const prompt = `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¤§å­¦ç”Ÿåˆ›ä¸šæ”¿ç­–é¡¾é—®ã€‚è¯·ä¸¥æ ¼æ ¹æ®ä¸‹é¢æä¾›çš„æ”¿ç­–åº“ä¿¡æ¯ï¼Œä¸ºä¸€ä½åˆ›ä¸šè€…åˆ†æä»–å¯èƒ½ç”³è¯·åˆ°çš„æ”¿ç­–ã€‚åœ¨åˆ†ææ—¶ï¼Œè¯·é‡ç‚¹å…³æ³¨ä»–çš„â€œå…·ä½“éœ€æ±‚â€ã€‚æ”¿ç­–åº“ï¼š${POLICY_DATABASE} åˆ›ä¸šè€…æƒ…å†µï¼š${userSituation} è¯·ä»¥äº²åˆ‡ã€ä¸“ä¸šçš„å£å»ï¼Œé€æ¡åˆ†æä»–æœ€å¯èƒ½ç¬¦åˆçš„2-3é¡¹æ”¿ç­–ï¼Œå¹¶è¯´æ˜ç†ç”±ã€‚æœ€åç»™ä¸€å¥é¼“åŠ±çš„è¯ã€‚`;
        const responseText = await callDeepSeekAI(prompt);
        let htmlResponse = responseText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        aiAnswerContainer.innerHTML = htmlResponse;

        // --- 2. è´¢åŠ¡æ•°æ®ç”Ÿæˆã€æ‘˜è¦ä¸å›¾è¡¨ ---
        const financialData = generateFinancialData(inputs);
        financialDataForExport = financialData; // ä¿å­˜ç”¨äºå¯¼å‡º
        renderFinancialSummary(financialData, Number(inputs.subsidy_amount));
        renderChart(financialData);

        setButtonLoading(simulateBtnText, simulateSpinner, simulateBtn, false);
    });

    exportPdfBtn.addEventListener('click', () => {
        const { jsPDF } = window.jspdf;
        const reportContent = document.getElementById('report-content');
        
        const confirmation = document.createElement('div');
        confirmation.textContent = 'æ­£åœ¨ç”ŸæˆPDFæŠ¥å‘Šï¼Œè¯·ç¨å€™...';
        confirmation.style.cssText = `
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background-color: #2c5282; color: white; padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 1000;
        `;
        document.body.appendChild(confirmation);

        html2canvas(reportContent, { 
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff'
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'pt',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save("åˆ›ä¸šè´¢æ”¿æ”¯æŒåˆ†ææŠ¥å‘Š.pdf");
            document.body.removeChild(confirmation);
        }).catch(err => {
            console.error("PDFç”Ÿæˆå¤±è´¥:", err);
            document.body.removeChild(confirmation);
            alert("æŠ±æ­‰ï¼ŒPDFç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚");
        });
    });

    exportExcelBtn.addEventListener('click', () => {
        if (!financialDataForExport) {
            alert("è¯·å…ˆè¿›è¡Œæ¨¡æ‹Ÿï¼Œç”Ÿæˆè´¢åŠ¡æ•°æ®åå†å¯¼å‡ºã€‚");
            return;
        }

        const worksheetData = [
            ["æœˆä»½", "æ— è¡¥è´´æœŸæœ«ç°é‡‘ (å…ƒ)", "æœ‰è¡¥è´´æœŸæœ«ç°é‡‘ (å…ƒ)"]
        ];
        for (let i = 0; i < 12; i++) {
            worksheetData.push([
                financialDataForExport.months[i],
                financialDataForExport.noSubsidy[i],
                financialDataForExport.withSubsidy[i]
            ]);
        }
        
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(worksheetData);
        XLSX.utils.book_append_sheet(wb, ws, "è´¢åŠ¡æ¨¡æ‹Ÿæ•°æ®");
        XLSX.writeFile(wb, "è´¢åŠ¡æ¨¡æ‹Ÿæ•°æ®.xlsx");
    });
</script>
</body>
</html>
